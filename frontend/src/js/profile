// profile.js
import { showMessage } from "./utils.js";

const messagesContainer = "profile-messages";

document.addEventListener("DOMContentLoaded", () => {
  loadProfile();

  const saveBtn = document.getElementById("save-profile");
  const deleteBtn = document.getElementById("delete-profile");

  saveBtn?.addEventListener("click", saveProfile);
  deleteBtn?.addEventListener("click", deleteProfile);
});

async function loadProfile() {
  try {
    const userId = getUserId(); // placeholder: might come from backend session
    const res = await fetch(`/api/users/${userId}`);
    if (!res.ok) throw new Error("Failed to load profile");

    const profile = await res.json();
    document.getElementById("profile-name").value = profile.firstName + " " + profile.lastName;
    document.getElementById("profile-email").value = profile.email;
    document.getElementById("profile-role").value = profile.role;
  } catch (err) {
    showMessage(messagesContainer, err.message, "error");
  }
}

async function saveProfile() {
  try {
    const userId = getUserId();
    const data = {
      firstName: document.getElementById("profile-name").value.split(" ")[0],
      lastName: document.getElementById("profile-name").value.split(" ")[1] || "",
      email: document.getElementById("profile-email").value,
      role: document.getElementById("profile-role").value
    };

    const res = await fetch(`/api/users/${userId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    if (!res.ok) throw new Error("Failed to update profile");

    showMessage(messagesContainer, "Profile updated!", "success");
  } catch (err) {
    showMessage(messagesContainer, err.message, "error");
  }
}

async function deleteProfile() {
  try {
    const userId = getUserId();
    const res = await fetch(`/api/users/${userId}`, { method: "DELETE" });
    if (!res.ok) throw new Error("Failed to delete profile");

    showMessage(messagesContainer, "Profile deleted.", "success");
    setTimeout(() => (window.location.href = "index.html"), 1500);
  } catch (err) {
    showMessage(messagesContainer, err.message, "error");
  }
}

function getUserId() {
  // TODO: Replace with actual logic (maybe backend provides /api/users/me)
  return "current-user-id";
}
